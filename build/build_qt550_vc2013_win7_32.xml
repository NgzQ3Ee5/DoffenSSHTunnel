<project name="doffensshtunnel" default="win32" basedir=".">
	
	<description>
        DoffenSSHTunnel
    </description>
	
	<!--APP_VERSION=0.9.27-->
	<property file="build.properties"/>
	<property name="distname" value="DoffenSSHTunnel"/>
	<property name="distname_exe" value="DoffenSSHTunnel.exe"/>
	<property name="version" value="v${APP_VERSION}"/>
	<property name="distfullname" value="${distname}-${version}-Win32"/>
	<property name="windir" value="C:/WINDOWS"/>
	<property name="depsdir" value="../deps"/>
	<!-- C:\Qt\DoffenSSHTunnel\build-DoffenSSHTunnel_32bit-Release -->
	<property name="builddir_win32" value="c:/qt/build-DoffenSSHTunnel_32bit-Release"/>
	<property name="distdir_win32" value="${builddir_win32}/dist"/>
	
	<property environment="env"/>	
	<property name="qtdir" value="${env.QTDIR}"/>
	
	<target name="nothing"></target>
		
	<target name="win32" depends="clean_win32" description="create dist files">
	
		<echo message="Execute windeployqt"/>
		<exec executable="windeployqt" failonerror="true" failifexecutionfails="true">
			<arg value="--dir"/>
			<arg value="${distdir_win32}/windeployqt"/>
			<arg value="${builddir_win32}/source/release/DoffenSSHTunnel.exe"/>
		</exec>

		<echo message="Copy DoffenSSHTunnel.exe"/>
		<copy file="${builddir_win32}/source/release/DoffenSSHTunnel.exe" tofile="${distdir_win32}/${distfullname}/${distname_exe}"/>		
		
		<echo message="Copy dependencies"/>
		<copy todir="${distdir_win32}/${distfullname}">
			<fileset dir="${depsdir}/putty_v0.7.2/release_win32">
				<include name="**/**"/>
			</fileset>		
			<fileset dir="${distdir_win32}/windeployqt">
				<include name="**/**"/>
			</fileset>	
			<fileset dir="${depsdir}/msvc2013_release_win32">
				<include name="**/**"/>
			</fileset>
			<fileset dir="${depsdir}/winscp_v5.13.9/release_win32">
				<include name="**/**"/>
			</fileset>	
			<fileset dir="${depsdir}/windows_scripts">
				<include name="**/**"/>
			</fileset>	
		</copy>
		
		<echo message="Copy themes"/>
		<copy todir="${distdir_win32}/${distfullname}/themes">
			<fileset dir="${depsdir}/themes">
				<include name="**/**"/>
			</fileset>		
		</copy>
		
		<echo message="Execute rcedit"/>
		<exec executable="${depsdir}/windows_rcedit/rcedit-x64.exe" failonerror="true" failifexecutionfails="true">
			<arg value="${distdir_win32}/${distfullname}/${distname_exe}"/>
			
			<arg value="--set-product-version"/>
			<arg value="${APP_VERSION}"/>
			
			<arg value="--set-file-version"/>
			<arg value="${APP_VERSION}"/>
			
			<arg value="--set-version-string"/>
			<arg value="ProductName"/>
			<arg value="${distname}"/>
			
			<arg value="--set-version-string"/>
			<arg value="FileDescription"/>
			<arg value="SSH Tunnel Manager"/>
			
			<arg value="--set-version-string"/>
			<arg value="InternalName"/>
			<arg value="${distname}"/>
			
			<arg value="--set-version-string"/>
			<arg value="OriginalFilename"/>
			<arg value="${distname_exe}"/>
			
			<arg value="--set-version-string"/>
			<arg value="LegalCopyright"/>
			<arg value="Copyright Â® Lars-Flemming Clausen"/>
		</exec>
		
		<echo message="Execute signtool"/>
		<exec executable="C:\Program Files (x86)\Windows Kits\8.1\bin\x86\signtool" failonerror="true" failifexecutionfails="true">
			<arg value="sign"/>
			
			<arg value="/v"/>
			
			<arg value="/t"/>
			<arg value="http://timestamp.digicert.com"/>
			
			<arg value="/d"/>
			<arg value="${distname}"/>
			
			<arg value="/n"/>
			<arg value="Lars-Flemming Clausen"/>
			
			<arg value="${distdir_win32}/${distfullname}/${distname_exe}"/>
		</exec>
		
		<!-- Create application zip file -->
		<echo message="Create zip file"/>
		<zip destfile="${distdir_win32}/${distfullname}.zip">
			<zipfileset dir="${distdir_win32}/${distfullname}" prefix="${distfullname}"/>
		</zip>		
		
	</target>  
		
	<target name="clean_win32" description="clean up" >
		<delete dir="${distdir_win32}/windeployqt"/>
		<delete dir="${distdir_win32}/${distfullname}"/>
		<delete file="${distdir_win32}/${distfullname}.zip"/>
	</target>

</project>
